<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÈªûÈ§êÁ≥ªÁµ±</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 15px;
        }

        .header h1 {
            font-size: 22px;
            margin-bottom: 5px;
        }

        .header .date {
            font-size: 14px;
            opacity: 0.9;
        }

        .header .deadline {
            font-size: 13px;
            color: #ffcc00;
            margin-top: 5px;
        }

        .user-info {
            background: white;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-info img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }

        .user-info .name {
            font-weight: bold;
            font-size: 15px;
        }

        .section {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
        }

        .section-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .meal-option {
            padding: 10px;
            border: 2px solid #eee;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .meal-option:hover {
            border-color: #667eea;
        }

        .meal-option.selected {
            border-color: #4CAF50;
            background: #f0fff0;
        }

        .meal-option .option-name {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .meal-option .option-desc {
            font-size: 12px;
            color: #666;
        }

        .skip-option {
            padding: 10px;
            border: 2px solid #eee;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            color: #999;
        }

        .skip-option:hover {
            border-color: #f44336;
        }

        .skip-option.selected {
            border-color: #f44336;
            background: #fff5f5;
            color: #f44336;
        }

        .submit-btn {
            width: 100%;
            padding: 16px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            transition: background 0.2s;
        }

        .submit-btn:hover {
            background: #45a049;
        }

        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            color: white;
            padding: 50px;
            font-size: 18px;
        }

        .success-message {
            background: white;
            border-radius: 12px;
            padding: 30px 20px;
            text-align: center;
        }

        .success-message .icon {
            font-size: 50px;
            margin-bottom: 15px;
        }

        .success-message h2 {
            color: #4CAF50;
            margin-bottom: 10px;
        }

        .success-message .order-summary {
            text-align: left;
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 13px;
            line-height: 1.6;
        }

        .close-btn {
            width: 100%;
            padding: 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
        }

        .kcal {
            font-size: 11px;
            color: #4CAF50;
            font-weight: normal;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="loading" class="loading">
            ËºâÂÖ•‰∏≠...
        </div>

        <div id="main-content" style="display: none;">
            <div class="header">
                <h1>üçΩÔ∏è ÊòéÊó•ÈªûÈ§ê</h1>
                <div class="date" id="order-date"></div>
                <div class="deadline">‚è∞ Êà™Ê≠¢ÊôÇÈñìÔºö17:00</div>
            </div>

            <div class="user-info" id="user-info">
                <img id="user-avatar" src="" alt="avatar">
                <div class="name" id="user-name"></div>
            </div>

            <div id="meal-sections"></div>

            <button class="submit-btn" id="submit-btn" onclick="submitOrder()">
                ÈÄÅÂá∫ÈªûÈ§ê
            </button>
        </div>

        <div id="success-content" style="display: none;">
            <div class="success-message">
                <div class="icon">‚úÖ</div>
                <h2>ÈªûÈ§êÂÆåÊàêÔºÅ</h2>
                <div class="order-summary" id="order-summary"></div>
            </div>
            <button class="close-btn" onclick="closeLiff()">ÈóúÈñâ</button>
        </div>
    </div>

    <script>
        // Ë®≠ÂÆö
        const LIFF_ID = "2009034111-mrAxuPkT";

        // ÂÆåÊï¥ËèúÂñÆË≥áÊñô
        const menuData = {
            breakfast: {
                name: "Êó©È§ê",
                icon: "üç≥",
                time: "07:30-08:00",
                kcal: 400,
                options: [
                    { id: "b1", name: "ÈÆ≠È≠öÁÇíÈùíËèú+Ëõã", desc: "ÈÆ≠È≠ö100g„ÄÅÈùíËèú200g„ÄÅÈõûËõã1È°Ü„ÄÅÈ£Ø80g" },
                    { id: "b2", name: "Ëù¶‰ªÅÁÉòËõã+ÁâõÂ•∂", desc: "Ëù¶‰ªÅ6Èöª„ÄÅËõã2ÂÄã„ÄÅÁâõÂ•∂150ml„ÄÅÁáïÈ∫•30g" },
                    { id: "b3", name: "ÈõûËÇâÈ£ØÁ≥∞", desc: "ÂéªÁöÆÈõûËÇâ80g„ÄÅÈùíËèú100g„ÄÅÈ£Ø80g" },
                    { id: "b4", name: "Ëí∏Ëõã", desc: "ÁáïÈ∫•20g„ÄÅËõã2È°Ü„ÄÅÊµ∑ÈÆÆ60g„ÄÅ2Á¢óÈùíËèú" },
                    { id: "b5", name: "Êµ∑ÈÆÆË±ÜËÖêÈ§Ö", desc: "Êµ∑ÈÆÆ80g„ÄÅË±ÜËÖê100g„ÄÅÁáïÈ∫•40g„ÄÅËõã1ÂÄã„ÄÅÈùíËèú100g" }
                ]
            },
            morning_snack: {
                name: "Êó©ÈªûÂøÉ",
                icon: "ü•ê",
                time: "10:30-11:00",
                kcal: 150,
                options: [
                    { id: "ms1", name: "Ëõã2ÂÄã", desc: "" },
                    { id: "ms2", name: "ÂéªÁöÆÈõûËÖøËÇâÊç≤", desc: "120g" },
                    { id: "ms3", name: "ÈÆ≠È≠öËî¨Ëèú", desc: "ÈÆ≠È≠ö80g" },
                    { id: "ms4", name: "Áü≥ÊñëÈ≠öÊéí", desc: "120g" },
                    { id: "ms5", name: "Ê∫´ÁâõÂ•∂ÁáïÈ∫•", desc: "ÁâõÂ•∂200ml+ÁáïÈ∫•Áâá30g" },
                    { id: "ms6", name: "ËõãÂ•∂Â∏É‰∏Å", desc: "Ëõã1ÂÄã+ÁâõÂ•∂150ml" }
                ]
            },
            lunch: {
                name: "ÂçàÈ§ê",
                icon: "üç±",
                time: "13:00-13:30",
                kcal: 400,
                options: [
                    { id: "l1", name: "Ê®ôÊ∫ñÈ§ê", desc: "ÈùíËèú200g + ËÇâÈ°û120g + È£Ø80g" }
                ],
                hasSoup: true
            },
            afternoon_snack: {
                name: "‰∏ãÂçàÈªûÂøÉ",
                icon: "üç∞",
                time: "15:30-16:00",
                kcal: 150,
                options: [
                    { id: "as1", name: "Ëõã2ÂÄã", desc: "" },
                    { id: "as2", name: "ÂéªÁöÆÈõûËÖøËÇâÊç≤", desc: "120g" },
                    { id: "as3", name: "ÈÆ≠È≠öËî¨Ëèú", desc: "ÈÆ≠È≠ö80g" },
                    { id: "as4", name: "Áü≥ÊñëÈ≠öÊéí", desc: "120g" },
                    { id: "as5", name: "Ê∫´ÁâõÂ•∂ÁáïÈ∫•", desc: "ÁâõÂ•∂200ml+ÁáïÈ∫•Áâá30g" },
                    { id: "as6", name: "ËõãÂ•∂Â∏É‰∏Å", desc: "Ëõã1ÂÄã+ÁâõÂ•∂150ml" },
                    { id: "as7", name: "ÂÑ™ÈÖ™‰π≥", desc: "200mlÔºà‰∏ãÂçàÈôêÂÆöÔºâ" }
                ]
            },
            dinner: {
                name: "ÊôöÈ§ê",
                icon: "üçΩÔ∏è",
                time: "19:00-19:30",
                kcal: 400,
                options: [
                    { id: "d1", name: "Ê®ôÊ∫ñÈ§ê", desc: "ÈùíËèú200g + ËÇâÈ°û120g + È£Ø80g" }
                ],
                hasSoup: true
            },
            late_night: {
                name: "ÂÆµÂ§ú",
                icon: "üåô",
                time: "21:30-22:00",
                kcal: 150,
                options: [
                    { id: "ln1", name: "Ëõã2ÂÄã", desc: "" },
                    { id: "ln2", name: "ÂéªÁöÆÈõûËÖøËÇâÊç≤", desc: "120g" },
                    { id: "ln3", name: "ÈÆ≠È≠öËî¨Ëèú", desc: "ÈÆ≠È≠ö80g" },
                    { id: "ln4", name: "Áü≥ÊñëÈ≠öÊéí", desc: "120g" },
                    { id: "ln5", name: "Ê∫´ÁâõÂ•∂ÁáïÈ∫•", desc: "ÁâõÂ•∂200ml+ÁáïÈ∫•Áâá30g" },
                    { id: "ln6", name: "ËõãÂ•∂Â∏É‰∏Å", desc: "Ëõã1ÂÄã+ÁâõÂ•∂150ml" }
                ]
            }
        };

        // ÊπØÂìÅÈÅ∏È†Ö
        const soupOptions = [
            { id: "soup1", name: "ËñëÁµ≤Áü≥ÊñëÈ≠öÊπØ", desc: "È≠öËÇâ100g+ËñëÁµ≤" },
            { id: "soup2", name: "Ëõ§ËúäÁµ≤ÁìúÊπØ", desc: "Ëõ§Ëúä15ÂÄã+Áµ≤Áìú100g" },
            { id: "soup3", name: "ÈÆÆËù¶Ë±ÜËÖêÊπØ", desc: "Ëù¶Â≠ê6Èöª+ÊùøË±ÜËÖêÂçäÁõí" },
            { id: "soup4", name: "ÈõûËÖøÈ¶ôËèáÊπØ", desc: "ÂéªÁöÆÈõûËÖø1Èöª+È¶ôËèá3Êúµ" },
            { id: "soup5", name: "ÈÆÆÈ≠öÂë≥ÂôåÊπØ", desc: "ÈÆ≠È≠öÂ°ä50g+Âë≥Âôå" }
        ];

        // ‰ΩøÁî®ËÄÖÈÅ∏Êìá
        let userSelections = {};
        let userProfile = null;

        // ÂàùÂßãÂåñ
        async function initializeLiff() {
            try {
                await liff.init({ liffId: LIFF_ID });

                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                // ÂèñÂæó‰ΩøÁî®ËÄÖË≥áÊñô
                userProfile = await liff.getProfile();
                document.getElementById("user-avatar").src = userProfile.pictureUrl || "";
                document.getElementById("user-name").textContent = userProfile.displayName;

                // Ë®≠ÂÆöÊó•Êúü
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                const dateStr = tomorrow.toLocaleDateString("zh-TW", {
                    year: "numeric",
                    month: "long",
                    day: "numeric",
                    weekday: "long"
                });
                document.getElementById("order-date").textContent = dateStr;

                // ÂàùÂßãÂåñÈÅ∏Êìá
                Object.keys(menuData).forEach(mealId => {
                    userSelections[mealId] = null; // null = ÈÇÑÊ≤íÈÅ∏
                });
                userSelections["lunch_soup"] = null;
                userSelections["dinner_soup"] = null;

                // Ê∏≤ÊüìËèúÂñÆ
                renderMenuSections();

                // È°ØÁ§∫‰∏ªÂÖßÂÆπ
                document.getElementById("loading").style.display = "none";
                document.getElementById("main-content").style.display = "block";

            } catch (error) {
                console.error("LIFF ÂàùÂßãÂåñÂ§±Êïó:", error);
                document.getElementById("loading").textContent = "ËºâÂÖ•Â§±ÊïóÔºåË´ãÈáçË©¶";
            }
        }

        // Ê∏≤ÊüìËèúÂñÆÂçÄÂ°ä
        function renderMenuSections() {
            const container = document.getElementById("meal-sections");
            let html = "";

            Object.keys(menuData).forEach(mealId => {
                const meal = menuData[mealId];
                html += `
                    <div class="section">
                        <div class="section-title">
                            ${meal.icon} ${meal.name}
                            <span class="kcal">${meal.time} (${meal.kcal}kcal)</span>
                        </div>
                        ${meal.options.map(opt => `
                            <div class="meal-option ${userSelections[mealId] === opt.id ? 'selected' : ''}"
                                 onclick="selectOption('${mealId}', '${opt.id}')">
                                <div class="option-name">${opt.name}</div>
                                ${opt.desc ? `<div class="option-desc">${opt.desc}</div>` : ''}
                            </div>
                        `).join('')}
                        <div class="skip-option ${userSelections[mealId] === 'skip' ? 'selected' : ''}"
                             onclick="selectOption('${mealId}', 'skip')">
                            ‚ùå ‰∏çÂêÉ
                        </div>
                        ${meal.hasSoup ? renderSoupSection(mealId) : ''}
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Ê∏≤ÊüìÊπØÂìÅÈÅ∏È†Ö
        function renderSoupSection(mealId) {
            const soupKey = mealId + "_soup";
            return `
                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px dashed #eee;">
                    <div style="font-size: 14px; font-weight: bold; margin-bottom: 8px;">ü•£ ÊπØÂìÅÔºàÈ§êÂâç20ÂàÜÈêòÔºâ</div>
                    ${soupOptions.map(opt => `
                        <div class="meal-option ${userSelections[soupKey] === opt.id ? 'selected' : ''}"
                             onclick="selectOption('${soupKey}', '${opt.id}')"
                             style="padding: 8px;">
                            <div class="option-name" style="font-size: 13px;">${opt.name}</div>
                            <div class="option-desc">${opt.desc}</div>
                        </div>
                    `).join('')}
                    <div class="skip-option ${userSelections[soupKey] === 'skip' ? 'selected' : ''}"
                         onclick="selectOption('${soupKey}', 'skip')"
                         style="padding: 8px; font-size: 13px;">
                        ‰∏çË¶ÅÊπØ
                    </div>
                </div>
            `;
        }

        // ÈÅ∏ÊìáÈÅ∏È†Ö
        function selectOption(mealId, optionId) {
            userSelections[mealId] = optionId;
            renderMenuSections();
        }

        // ÂèñÂæóÈÅ∏È†ÖÂêçÁ®±
        function getOptionName(mealId, optionId) {
            if (optionId === 'skip') return '‰∏çÂêÉ';
            if (optionId === null) return 'Êú™ÈÅ∏Êìá';

            // ÊπØÂìÅ
            if (mealId.includes('_soup')) {
                const soup = soupOptions.find(s => s.id === optionId);
                return soup ? soup.name : optionId;
            }

            // È§êÈªû
            const baseMealId = mealId.replace('_soup', '');
            const meal = menuData[baseMealId];
            if (meal) {
                const option = meal.options.find(o => o.id === optionId);
                return option ? option.name : optionId;
            }

            return optionId;
        }

        // ÈÄÅÂá∫ÈªûÈ§ê
        async function submitOrder() {
            // Ê™¢Êü•ÊòØÂê¶ÈÉΩÊúâÈÅ∏Êìá
            const unselected = Object.keys(menuData).filter(id => userSelections[id] === null);
            if (unselected.length > 0) {
                const names = unselected.map(id => menuData[id].name).join('„ÄÅ');
                alert(`Ë´ãÈÅ∏Êìá ${names} ÁöÑÈ§êÈªû`);
                return;
            }

            const btn = document.getElementById("submit-btn");
            btn.disabled = true;
            btn.textContent = "ÈÄÅÂá∫‰∏≠...";

            try {
                // ÁµÑÂêàË®ÇÂñÆÊëòË¶Å
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                const dateStr = tomorrow.toLocaleDateString("zh-TW");

                let summary = `üìã ${userProfile.displayName} ÁöÑÈªûÈ§ê\n`;
                summary += `üìÖ ${dateStr}\n`;
                summary += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;

                Object.keys(menuData).forEach(mealId => {
                    const meal = menuData[mealId];
                    const selection = getOptionName(mealId, userSelections[mealId]);
                    summary += `${meal.icon} ${meal.name}: ${selection}\n`;

                    // ÊπØÂìÅ
                    if (meal.hasSoup) {
                        const soupKey = mealId + "_soup";
                        const soupSelection = getOptionName(soupKey, userSelections[soupKey]);
                        if (userSelections[soupKey] && userSelections[soupKey] !== 'skip') {
                            summary += `   ü•£ ÊπØ: ${soupSelection}\n`;
                        }
                    }
                });

                // ‰ΩøÁî® LIFF ÁôºÈÄÅË®äÊÅØ
                if (liff.isApiAvailable("sendMessages")) {
                    await liff.sendMessages([{
                        type: "text",
                        text: summary
                    }]);
                }

                // È°ØÁ§∫ÊàêÂäüË®äÊÅØ
                let summaryHtml = "";
                Object.keys(menuData).forEach(mealId => {
                    const meal = menuData[mealId];
                    const selection = getOptionName(mealId, userSelections[mealId]);
                    summaryHtml += `<b>${meal.icon} ${meal.name}:</b> ${selection}<br>`;

                    if (meal.hasSoup && userSelections[mealId + "_soup"] && userSelections[mealId + "_soup"] !== 'skip') {
                        summaryHtml += `&nbsp;&nbsp;ü•£ ${getOptionName(mealId + "_soup", userSelections[mealId + "_soup"])}<br>`;
                    }
                });

                document.getElementById("order-summary").innerHTML = summaryHtml;
                document.getElementById("main-content").style.display = "none";
                document.getElementById("success-content").style.display = "block";

            } catch (error) {
                console.error("ÈÄÅÂá∫Â§±Êïó:", error);
                alert("ÈÄÅÂá∫Â§±ÊïóÔºåË´ãÈáçË©¶");
                btn.disabled = false;
                btn.textContent = "ÈÄÅÂá∫ÈªûÈ§ê";
            }
        }

        // ÈóúÈñâ LIFF
        function closeLiff() {
            if (liff.isInClient()) {
                liff.closeWindow();
            } else {
                window.close();
            }
        }

        // ÂïüÂãï
        initializeLiff();
    </script>
</body>
</html>
